name: Build

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2:00 UTC
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to build (e.g. "8.5.0", empty=check for updates)'
        type: string
        default: ''
      force_build:
        description: 'Force build all versions'
        type: boolean
        default: false
      rebuild_deps:
        description: 'Force rebuild static dependencies'
        type: boolean
        default: false

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  HOMEBREW_NO_ENV_HINTS: 1
  DEPS_VERSION: "v1"

permissions:
  contents: write

jobs:
  check-updates:
    name: Check for updates
    runs-on: ubuntu-latest
    outputs:
      php_versions: ${{ steps.check.outputs.php_versions }}
      has_builds: ${{ steps.check.outputs.has_builds }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for PHP updates
        id: check
        env:
          FORCE_BUILD: ${{ inputs.force_build }}
          INPUT_PHP_VERSION: ${{ inputs.php_version }}
        run: |
          # If specific PHP version provided, build only that
          if [[ -n "$INPUT_PHP_VERSION" ]]; then
            echo "Building specific PHP version: $INPUT_PHP_VERSION"
            echo "php_versions=[\"$INPUT_PHP_VERSION\"]" >> $GITHUB_OUTPUT
            echo "has_builds=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Fetch supported PHP minor versions from php.watch API
          echo "Fetching supported PHP versions from php.watch..."
          SUPPORTED_MINORS=$(curl -fsSL "https://php.watch/api/v1/versions/secure" 2>/dev/null | jq -r '.data | to_entries[] | .value.name' | sort -V | tr '\n' ' ')
          echo "Supported PHP minors: $SUPPORTED_MINORS"

          # Fetch latest patch versions from php.net API
          echo "Fetching PHP versions from php.net..."
          LATEST_PHP="{}"
          for minor in $SUPPORTED_MINORS; do
            version=$(curl -fsSL "https://www.php.net/releases/index.php?json&version=${minor}" 2>/dev/null | jq -r '.version // empty')
            if [[ -n "$version" ]]; then
              echo "  PHP $minor: $version"
              LATEST_PHP=$(echo "$LATEST_PHP" | jq -c --arg m "$minor" --arg v "$version" '. + {($m): $v}')
            fi
          done

          echo "Latest PHP versions: $LATEST_PHP"

          # Load current versions
          CURRENT_PHP=$(jq '.php // {}' versions.json 2>/dev/null || echo "{}")
          echo "Current PHP versions: $CURRENT_PHP"

          # Compare and find versions to build
          PHP_TO_BUILD="[]"

          if [[ "$FORCE_BUILD" == "true" ]]; then
            echo "Force build requested - building all PHP versions"
            PHP_TO_BUILD=$(echo "$LATEST_PHP" | jq -c '[.[] | values]')
          else
            for minor in $SUPPORTED_MINORS; do
              latest_ver=$(echo "$LATEST_PHP" | jq -r --arg m "$minor" '.[$m] // empty')
              current_ver=$(echo "$CURRENT_PHP" | jq -r --arg m "$minor" '.[$m] // "0.0.0"')

              [[ -z "$latest_ver" ]] && continue

              if [[ "$current_ver" == "0.0.0" ]]; then
                echo "PHP $minor: NEW -> $latest_ver"
                PHP_TO_BUILD=$(echo "$PHP_TO_BUILD" | jq -c --arg v "$latest_ver" '. + [$v]')
              elif [[ $(printf '%s\n%s' "$latest_ver" "$current_ver" | sort -V | tail -1) == "$latest_ver" && "$latest_ver" != "$current_ver" ]]; then
                echo "PHP $minor: $current_ver -> $latest_ver (upgrade)"
                PHP_TO_BUILD=$(echo "$PHP_TO_BUILD" | jq -c --arg v "$latest_ver" '. + [$v]')
              else
                echo "PHP $minor: $current_ver (unchanged)"
              fi
            done
          fi

          echo "PHP versions to build: $PHP_TO_BUILD"

          # Set outputs
          HAS_BUILDS="false"
          if [[ $(echo "$PHP_TO_BUILD" | jq 'length') -gt 0 ]]; then
            HAS_BUILDS="true"
          fi

          echo "php_versions=$PHP_TO_BUILD" >> $GITHUB_OUTPUT
          echo "has_builds=$HAS_BUILDS" >> $GITHUB_OUTPUT

  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.platform.name }})
    needs: check-updates
    if: needs.check-updates.outputs.has_builds == 'true'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        php_version: ${{ fromJson(needs.check-updates.outputs.php_versions) }}
        platform:
          - { os: macos-26, name: darwin-arm64, arch: arm64 }
    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: brew install -q autoconf automake bison re2c pkg-config libtool cmake zstd

      - name: Make scripts executable
        run: chmod +x scripts/*.sh scripts/deps/*.sh

      - name: Cache static dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: /opt/phm-deps/${{ matrix.platform.name }}
          key: phm-deps-${{ matrix.platform.name }}-${{ env.DEPS_VERSION }}-${{ hashFiles('scripts/deps/*.sh') }}
          restore-keys: |
            phm-deps-${{ matrix.platform.name }}-${{ env.DEPS_VERSION }}-

      - name: Build static dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true' || inputs.rebuild_deps == true
        run: |
          sudo mkdir -p /opt/phm-deps/${{ matrix.platform.name }}
          sudo chown -R $USER /opt/phm-deps
          ./scripts/deps/build-all-deps.sh
        env:
          CC: clang
          CXX: clang++

      - name: Verify static dependencies
        run: |
          DEPS_PREFIX="/opt/phm-deps/${{ matrix.platform.name }}"
          for lib in libz.a libssl.a libcrypto.a libedit.a libxml2.a libcurl.a libsqlite3.a libpq.a; do
            if [[ -f "${DEPS_PREFIX}/lib/${lib}" ]]; then
              echo "✓ ${lib}"
            else
              echo "✗ ${lib} - MISSING" && exit 1
            fi
          done

      - name: Build PHP core packages
        run: ./scripts/build-php-core.sh ${{ matrix.php_version }}
        env:
          CC: clang
          CXX: clang++

      - name: Build all extensions
        run: ./scripts/build-all-extensions.sh ${{ matrix.php_version }} --continue-on-error
        env:
          CC: clang
          CXX: clang++

      - name: Verify PHP binary
        run: |
          PHP_BIN="/opt/php/${PHP_VERSION%.*}/bin/php"
          if [[ -f "$PHP_BIN" ]]; then
            echo "Dependencies:"
            otool -L "$PHP_BIN"
            if otool -L "$PHP_BIN" | grep -q "/opt/homebrew\|/usr/local/opt"; then
              echo "::warning::PHP binary has Homebrew dependencies!"
            else
              echo "✓ PHP binary has no Homebrew dependencies"
            fi
          fi
        env:
          PHP_VERSION: ${{ matrix.php_version }}

      - name: Show build report
        if: always()
        run: |
          if [[ -f dist/build-report.json ]]; then
            echo "Summary:"
            jq -r '.summary | "  Total: \(.total) | Success: \(.success) | Failed: \(.failed)"' dist/build-report.json
            echo ""
            echo "Successful:"
            jq -r '.extensions[] | select(.status == "success") | "  ✓ \(.name) \(.version)"' dist/build-report.json || true
            echo ""
            echo "Failed:"
            jq -r '.extensions[] | select(.status == "failed") | "  ✗ \(.name): \(.error)"' dist/build-report.json || true
          fi

      - name: List built packages
        run: |
          echo "Built packages:"
          ls -la dist/*.tar.zst 2>/dev/null || echo "No packages found"
          echo "Count: $(ls dist/*.tar.zst 2>/dev/null | wc -l)"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/*.tar.zst
          retention-days: 7

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/logs/
          retention-days: 14
          if-no-files-found: ignore

  publish:
    name: Publish PHP ${{ matrix.php_version }}
    needs: [check-updates, build]
    if: needs.check-updates.outputs.has_builds == 'true'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        php_version: ${{ fromJson(needs.check-updates.outputs.php_versions) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: php-${{ matrix.php_version }}-*
          path: artifacts/
          merge-multiple: true

      - name: Validate packages
        run: |
          echo "Packages for PHP ${{ matrix.php_version }}:"
          ls -la artifacts/
          echo "Total: $(ls artifacts/*.tar.zst 2>/dev/null | wc -l) packages"

          # Check required extensions
          VERSION="${{ matrix.php_version }}"
          for ext in redis xdebug; do
            if ls artifacts/php${VERSION}-${ext}*_*.tar.zst 1>/dev/null 2>&1; then
              echo "✓ $ext"
            else
              echo "✗ $ext MISSING" && exit 1
            fi
          done

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ matrix.php_version }}"
          TAG="php-${VERSION}"

          # Delete existing release ONLY if rebuilding the same version
          # (keeps old patch versions like 8.5.0 when building 8.5.1)
          if gh release view "$TAG" &>/dev/null; then
            echo "Rebuilding $TAG - deleting existing release"
            gh release delete "$TAG" --yes --cleanup-tag 2>/dev/null || true
            sleep 2
          fi

          # Create release
          gh release create "$TAG" \
            --title "PHP ${VERSION}" \
            --notes "Pre-built PHP ${VERSION} packages for macOS (darwin-arm64)"

          # Upload in batches
          cd artifacts
          FILES=(*.tar.zst)
          for ((i=0; i<${#FILES[@]}; i+=10)); do
            BATCH=("${FILES[@]:i:10}")
            gh release upload "$TAG" "${BATCH[@]}" --clobber
            sleep 2
          done

  update-versions:
    name: Update versions.json
    needs: [check-updates, publish]
    if: needs.check-updates.outputs.has_builds == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Update versions.json
        env:
          PHP_VERSIONS: ${{ needs.check-updates.outputs.php_versions }}
        run: |
          CURRENT=$(cat versions.json)

          # Update PHP versions
          for ver in $(echo "$PHP_VERSIONS" | jq -r '.[]'); do
            MINOR="${ver%.*}"
            CURRENT=$(echo "$CURRENT" | jq --arg m "$MINOR" --arg v "$ver" '.php[$m] = $v')
          done

          # Update timestamp
          CURRENT=$(echo "$CURRENT" | jq --arg t "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '.last_check = $t')

          echo "$CURRENT" | jq '.' > versions.json
          cat versions.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json
          git diff --staged --quiet || git commit -m "Update versions.json after build"
          git push
