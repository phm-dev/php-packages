name: Build PHP Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  HOMEBREW_NO_ENV_HINTS: 1

jobs:
  prepare:
    name: Get latest PHP versions
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.filter.outputs.matrix }}
      has_versions: ${{ steps.filter.outputs.has_versions }}
    steps:
      - uses: actions/checkout@v4

      - name: Get secure PHP versions
        id: versions
        run: |
          chmod +x scripts/get-php-versions.sh
          MATRIX=$(./scripts/get-php-versions.sh --json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "All PHP versions: $MATRIX"

      - name: Filter out existing releases
        id: filter
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all versions
          ALL_VERSIONS='${{ steps.versions.outputs.matrix }}'

          # Get existing release tags
          EXISTING=$(gh release list --json tagName -q '.[].tagName' 2>/dev/null || echo "")

          # Filter out versions that already have releases
          FILTERED=$(echo "$ALL_VERSIONS" | jq -c '[.[] | select("php-" + . as $tag | env.EXISTING | split("\n") | index($tag) | not)]' --arg EXISTING "$EXISTING" 2>/dev/null || echo "$ALL_VERSIONS")

          # Handle empty jq arg issue - do it with a loop instead
          FILTERED="[]"
          for ver in $(echo "$ALL_VERSIONS" | jq -r '.[]'); do
            TAG="php-${ver}"
            if echo "$EXISTING" | grep -q "^${TAG}$"; then
              echo "Skipping $ver - release $TAG already exists"
            else
              echo "Will build $ver - no existing release"
              FILTERED=$(echo "$FILTERED" | jq -c ". + [\"$ver\"]")
            fi
          done

          echo "matrix=$FILTERED" >> $GITHUB_OUTPUT
          echo "Versions to build: $FILTERED"

          # Check if there are any versions to build
          COUNT=$(echo "$FILTERED" | jq 'length')
          if [[ "$COUNT" -gt 0 ]]; then
            echo "has_versions=true" >> $GITHUB_OUTPUT
          else
            echo "has_versions=false" >> $GITHUB_OUTPUT
            echo "No new versions to build"
          fi

  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.platform.name }})
    needs: prepare
    if: needs.prepare.outputs.has_versions == 'true'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.matrix) }}
        platform:
          - { os: macos-15, name: darwin-arm64 }
          - { os: macos-15-intel, name: darwin-amd64 }
    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install -q autoconf automake bison re2c pkg-config \
            openssl@3 libzip icu4c readline libxml2 libxslt \
            sqlite lz4 zstd oniguruma jpeg-turbo libpng freetype webp \
            libpq bzip2 curl libiconv zstd \
            rabbitmq-c libssh2 libmemcached

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Build PHP core packages
        run: ./scripts/build-php-core.sh ${{ matrix.php_version }}
        env:
          CC: clang
          CXX: clang++

      - name: Install PHP for extension building
        run: |
          PHP_VERSION="${{ matrix.php_version }}"
          PHP_MAJOR_MINOR="${PHP_VERSION%.*}"

          echo "Installing PHP ${PHP_MAJOR_MINOR} to /opt/php/${PHP_MAJOR_MINOR}..."
          sudo mkdir -p /opt/php/${PHP_MAJOR_MINOR}

          # Extract core packages to /opt/php
          for pkg in dist/php${PHP_MAJOR_MINOR}-{common,cli,dev,pear}_*.tar.zst; do
            if [[ -f "$pkg" ]]; then
              echo "Extracting $pkg..."
              zstd -dc "$pkg" | sudo tar -xf - -C / --strip-components=1 files/
            fi
          done

          # Verify installation
          /opt/php/${PHP_MAJOR_MINOR}/bin/php -v
          /opt/php/${PHP_MAJOR_MINOR}/bin/php-config --version

      - name: Build extensions
        run: |
          PHP_VERSION="${{ matrix.php_version }}"

          EXTENSIONS=(
            redis
            igbinary
            mongodb
            amqp
            xdebug
            swoole
            pcov
            apcu
          )

          for ext in "${EXTENSIONS[@]}"; do
            echo "=========================================="
            echo "Building extension: $ext"
            echo "=========================================="
            ./scripts/build-extension.sh "$ext" "$PHP_VERSION" || {
              echo "Warning: Failed to build $ext, continuing..."
            }
          done
        env:
          CC: clang
          CXX: clang++

      - name: List built packages
        run: ls -la dist/*.tar.zst

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/*.tar.zst
          retention-days: 7

  # Publish each PHP version as a separate release
  publish-version:
    name: Publish PHP ${{ matrix.php_version }}
    needs: [prepare, build]
    if: needs.prepare.outputs.has_versions == 'true'
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts for this version
        uses: actions/download-artifact@v4
        with:
          pattern: php-${{ matrix.php_version }}-*
          path: artifacts/
          merge-multiple: true

      - name: List downloaded packages
        run: |
          echo "Packages for PHP ${{ matrix.php_version }}:"
          ls -la artifacts/

      - name: Create version release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ matrix.php_version }}"
          TAG="php-${VERSION}"

          # Create release notes
          cat > release_notes.md << EOF
          ## PHP ${VERSION}

          Pre-built PHP ${VERSION} packages for macOS.

          **Platforms:**
          - darwin-arm64 (Apple Silicon)
          - darwin-amd64 (Intel Mac)

          **Packages included:**
          - php${VERSION%.*}-common (shared libraries)
          - php${VERSION%.*}-cli (command line)
          - php${VERSION%.*}-fpm (FastCGI Process Manager)
          - php${VERSION%.*}-cgi (CGI binary)
          - php${VERSION%.*}-dev (development headers)
          - Extensions: redis, igbinary, mongodb, amqp, xdebug, swoole, pcov, apcu

          ### Installation

          \`\`\`bash
          phm install php${VERSION%.*}-cli php${VERSION%.*}-fpm
          \`\`\`
          EOF

          # Create release with retry
          for i in 1 2 3; do
            gh release create "$TAG" \
              --title "PHP ${VERSION}" \
              --notes-file release_notes.md \
              artifacts/*.tar.zst \
              && break
            echo "Attempt $i failed, waiting 30s..."
            sleep 30
          done

  # Update central index.json from ALL releases
  update-index:
    name: Update package index
    needs: [prepare, publish-version]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install zstd
        run: sudo apt-get install -y zstd

      - name: Download packages from all releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist

          # Get all php-* releases
          RELEASES=$(gh release list --json tagName -q '.[].tagName | select(startswith("php-"))' 2>/dev/null || echo "")

          if [[ -z "$RELEASES" ]]; then
            echo "No releases found"
            exit 0
          fi

          echo "Found releases:"
          echo "$RELEASES"

          # Download packages from each release
          for tag in $RELEASES; do
            echo "Downloading packages from $tag..."
            gh release download "$tag" --pattern "*.tar.zst" --dir dist/ --skip-existing || true
          done

          echo "Total packages downloaded:"
          ls -la dist/

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Generate index.json
        run: |
          if [[ ! -d dist ]] || [[ -z "$(ls dist/*.tar.zst 2>/dev/null)" ]]; then
            echo "No packages found, skipping index generation"
            exit 0
          fi

          ./scripts/generate-index.sh \
            --base-url "https://github.com/${{ github.repository }}/releases/download"

      - name: Commit and push index.json
        run: |
          if [[ ! -f dist/index.json ]]; then
            echo "No index.json generated, skipping"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          cp dist/index.json .
          git add index.json
          git diff --staged --quiet || git commit -m "Update index.json"
          git push
