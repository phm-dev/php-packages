name: Build PHP Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  HOMEBREW_NO_ENV_HINTS: 1

jobs:
  prepare:
    name: Get latest PHP versions
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.versions.outputs.matrix }}
    steps:
      - name: Fetch secure PHP versions from php.watch API
        id: versions
        run: |
          echo "Fetching secure PHP versions from php.watch..."

          # Get all secure versions from php.watch API
          MATRIX=$(curl -sf "https://php.watch/api/v1/versions/secure" | \
            jq -c '[.data | to_entries[] | select(.value.isSecureVersion == true) | .value.name]')

          echo "Secure versions: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.platform.name }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.matrix) }}
        platform:
          - { os: macos-15, name: darwin-arm64 }
          - { os: macos-15-intel, name: darwin-amd64 }
    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install -q autoconf automake bison re2c pkg-config \
            openssl@3 libzip icu4c readline libxml2 libxslt \
            sqlite lz4 zstd oniguruma jpeg-turbo libpng freetype webp \
            libpq bzip2 curl libiconv \
            rabbitmq-c libssh2 libmemcached

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Build PHP core packages
        run: ./scripts/build-php-core.sh ${{ matrix.php_version }}
        env:
          CC: clang
          CXX: clang++

      - name: Build extensions
        run: |
          PHP_VERSION="${{ matrix.php_version }}"

          # List of extensions to build
          EXTENSIONS=(
            redis
            igbinary
            mongodb
            amqp
            xdebug
            swoole
            pcov
            apcu
          )

          for ext in "${EXTENSIONS[@]}"; do
            echo "=========================================="
            echo "Building extension: $ext"
            echo "=========================================="
            ./scripts/build-extension.sh "$ext" "$PHP_VERSION" || {
              echo "Warning: Failed to build $ext, continuing..."
            }
          done
        env:
          CC: clang
          CXX: clang++

      - name: List built packages
        run: ls -la dist/*.tar.gz

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: php-packages-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/*.tar.gz
          retention-days: 7

  publish:
    name: Publish packages
    needs: [prepare, build]
    if: needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect packages
        run: |
          mkdir -p dist
          find artifacts/ -name '*.tar.gz' -exec cp {} dist/ \;
          ls -la dist/

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Generate index.json
        run: |
          ./scripts/generate-index.sh \
            --base-url "https://github.com/${{ github.repository }}/releases/download" \
            --release-tag "v${{ github.run_number }}"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: PHP Packages Build ${{ github.run_number }}
          body: |
            ## PHP Packages

            **Built versions:** ${{ needs.prepare.outputs.matrix }}

            **Platforms:**
            - darwin-arm64 (Apple Silicon)
            - darwin-amd64 (Intel Mac)

            ### Installation

            ```bash
            # Install phm first
            curl -fsSL https://raw.githubusercontent.com/phm-dev/phm/main/scripts/install-phm.sh | bash

            # Then install PHP
            phm update
            phm install php8.5-cli php8.5-fpm php8.5-redis
            ```
          files: |
            dist/*.tar.gz
            dist/index.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest index
        run: |
          # Copy index.json to repository for easy access
          cp dist/index.json .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.json
          git commit -m "Update index.json" || true
          git push || true
