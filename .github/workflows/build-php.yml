name: Build PHP Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  HOMEBREW_NO_ENV_HINTS: 1

jobs:
  prepare:
    name: Get latest PHP versions
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.versions.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Get secure PHP versions
        id: versions
        run: |
          chmod +x scripts/get-php-versions.sh
          MATRIX=$(./scripts/get-php-versions.sh --json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Versions to build: $MATRIX"

  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.platform.name }})
    needs: prepare
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.matrix) }}
        platform:
          - { os: macos-15, name: darwin-arm64 }
          - { os: macos-15-intel, name: darwin-amd64 }
    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install -q autoconf automake bison re2c pkg-config \
            openssl@3 libzip icu4c readline libxml2 libxslt \
            sqlite lz4 zstd oniguruma jpeg-turbo libpng freetype webp \
            libpq bzip2 curl libiconv zstd \
            rabbitmq-c libssh2 libmemcached

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Build PHP core packages
        run: ./scripts/build-php-core.sh ${{ matrix.php_version }}
        env:
          CC: clang
          CXX: clang++

      - name: Build extensions
        run: |
          PHP_VERSION="${{ matrix.php_version }}"

          EXTENSIONS=(
            redis
            igbinary
            mongodb
            amqp
            xdebug
            swoole
            pcov
            apcu
          )

          for ext in "${EXTENSIONS[@]}"; do
            echo "=========================================="
            echo "Building extension: $ext"
            echo "=========================================="
            ./scripts/build-extension.sh "$ext" "$PHP_VERSION" || {
              echo "Warning: Failed to build $ext, continuing..."
            }
          done
        env:
          CC: clang
          CXX: clang++

      - name: List built packages
        run: ls -la dist/*.tar.zst

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/*.tar.zst
          retention-days: 7

  # Publish each PHP version as a separate release
  publish-version:
    name: Publish PHP ${{ matrix.php_version }}
    needs: [prepare, build]
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts for this version
        uses: actions/download-artifact@v4
        with:
          pattern: php-${{ matrix.php_version }}-*
          path: artifacts/
          merge-multiple: true

      - name: List downloaded packages
        run: |
          echo "Packages for PHP ${{ matrix.php_version }}:"
          ls -la artifacts/

      - name: Create version release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ matrix.php_version }}"
          TAG="php-${VERSION}"

          # Delete existing release if exists (for updates)
          gh release delete "$TAG" --yes 2>/dev/null || true
          git push origin --delete "$TAG" 2>/dev/null || true

          # Create release notes
          cat > release_notes.md << EOF
          ## PHP ${VERSION}

          Pre-built PHP ${VERSION} packages for macOS.

          **Platforms:**
          - darwin-arm64 (Apple Silicon)
          - darwin-amd64 (Intel Mac)

          **Packages included:**
          - php${VERSION%.*}-common (shared libraries)
          - php${VERSION%.*}-cli (command line)
          - php${VERSION%.*}-fpm (FastCGI Process Manager)
          - php${VERSION%.*}-cgi (CGI binary)
          - php${VERSION%.*}-dev (development headers)
          - Extensions: redis, igbinary, mongodb, amqp, xdebug, swoole, pcov, apcu

          ### Installation

          \`\`\`bash
          phm install php${VERSION%.*}-cli php${VERSION%.*}-fpm
          \`\`\`
          EOF

          # Create release with retry
          for i in 1 2 3; do
            gh release create "$TAG" \
              --title "PHP ${VERSION}" \
              --notes-file release_notes.md \
              artifacts/*.tar.zst \
              && break
            echo "Attempt $i failed, waiting 30s..."
            sleep 30
          done

  # Update central index.json after all releases
  update-index:
    name: Update package index
    needs: [prepare, publish-version]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect all packages
        run: |
          mkdir -p dist
          find artifacts/ -name '*.tar.zst' -exec cp {} dist/ \;
          echo "Total packages:"
          ls -la dist/

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Generate index.json
        run: |
          # Generate index with version-specific release URLs
          ./scripts/generate-index.sh \
            --base-url "https://github.com/${{ github.repository }}/releases/download"

      - name: Commit and push index.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          cp dist/index.json .
          git add index.json
          git diff --staged --quiet || git commit -m "Update index.json"
          git push
