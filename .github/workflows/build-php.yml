name: Build PHP

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2:00 UTC
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to build (e.g. "8.5" resolves to latest 8.5.x)'
        type: string
        default: ''
      force_build:
        description: 'Force build without version check'
        type: boolean
        default: false

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  HOMEBREW_NO_ENV_HINTS: 1

jobs:
  prepare:
    name: Prepare build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_builds: ${{ steps.set-matrix.outputs.has_builds }}
      new_versions: ${{ steps.set-matrix.outputs.new_versions }}
    steps:
      - uses: actions/checkout@v4

      - name: Get secure PHP versions
        id: versions
        run: |
          chmod +x scripts/get-php-versions.sh
          VERSIONS=$(./scripts/get-php-versions.sh --json)
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
          echo "All PHP versions: $VERSIONS"

      - name: Determine versions to build
        id: set-matrix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_BUILD: ${{ inputs.force_build }}
          INPUT_PHP_VERSION: ${{ inputs.php_version }}
        run: |
          ALL_VERSIONS='${{ steps.versions.outputs.versions }}'

          # If specific PHP version requested, resolve it
          if [[ -n "$INPUT_PHP_VERSION" ]]; then
            echo "Resolving PHP version: $INPUT_PHP_VERSION"

            # Find matching version (e.g. "8.5" -> "8.5.0")
            RESOLVED=$(echo "$ALL_VERSIONS" | jq -r --arg v "$INPUT_PHP_VERSION" '.[] | select(startswith($v))' | head -1)

            if [[ -z "$RESOLVED" ]]; then
              echo "Error: No PHP version matching '$INPUT_PHP_VERSION' found"
              echo "Available versions: $ALL_VERSIONS"
              exit 1
            fi

            echo "Resolved to: $RESOLVED"
            ALL_VERSIONS="[\"$RESOLVED\"]"
          fi

          if [[ "$FORCE_BUILD" == "true" ]] || [[ -n "$INPUT_PHP_VERSION" ]]; then
            echo "Building specified versions: $ALL_VERSIONS"
            NEW_VERSIONS="$ALL_VERSIONS"
          else
            # Get existing release tags
            EXISTING=$(gh release list --json tagName -q '.[].tagName' 2>/dev/null | grep "^php-" || echo "")

            # Filter out versions that already have releases
            NEW_VERSIONS="[]"
            for ver in $(echo "$ALL_VERSIONS" | jq -r '.[]'); do
              TAG="php-${ver}"
              if echo "$EXISTING" | grep -q "^${TAG}$"; then
                echo "Skipping $ver - release $TAG already exists"
              else
                echo "Will build $ver - no existing release"
                NEW_VERSIONS=$(echo "$NEW_VERSIONS" | jq -c ". + [\"$ver\"]")
              fi
            done
          fi

          echo "new_versions=$NEW_VERSIONS" >> $GITHUB_OUTPUT
          echo "Versions to build: $NEW_VERSIONS"

          # Create matrix with platforms
          MATRIX=$(echo "$NEW_VERSIONS" | jq -c '{
            php_version: .,
            platform: [
              { os: "macos-15", name: "darwin-arm64" },
              { os: "macos-13", name: "darwin-amd64" }
            ]
          }')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # Check if there are any versions to build
          COUNT=$(echo "$NEW_VERSIONS" | jq 'length')
          if [[ "$COUNT" -gt 0 ]]; then
            echo "has_builds=true" >> $GITHUB_OUTPUT
          else
            echo "has_builds=false" >> $GITHUB_OUTPUT
            echo "No new versions to build"
          fi

  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.platform.name }})
    needs: prepare
    if: needs.prepare.outputs.has_builds == 'true'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.new_versions) }}
        platform:
          - { os: macos-15, name: darwin-arm64 }
          - { os: macos-13, name: darwin-amd64 }
    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install -q autoconf automake bison re2c pkg-config libtool cmake \
            openssl@3 libzip icu4c readline libxml2 libxslt \
            sqlite lz4 zstd oniguruma jpeg-turbo libpng freetype webp \
            libpq bzip2 curl libiconv

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Build PHP core packages
        run: ./scripts/build-php-core.sh ${{ matrix.php_version }}
        env:
          CC: clang
          CXX: clang++

      - name: List built packages
        run: |
          echo "Built packages:"
          ls -la dist/*.tar.zst 2>/dev/null || echo "No packages found"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/*.tar.zst
          retention-days: 7

  publish:
    name: Publish PHP ${{ matrix.php_version }}
    needs: [prepare, build]
    if: needs.prepare.outputs.has_builds == 'true'
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        php_version: ${{ fromJson(needs.prepare.outputs.new_versions) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: php-${{ matrix.php_version }}-*
          path: artifacts/
          merge-multiple: true

      - name: List packages
        run: |
          echo "Packages for PHP ${{ matrix.php_version }}:"
          ls -la artifacts/

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ matrix.php_version }}"
          TAG="php-${VERSION}"
          MINOR="${VERSION%.*}"

          # Create release notes
          cat > release_notes.md << 'EOF'
          ## PHP ${VERSION}

          Pre-built PHP ${VERSION} packages for macOS.

          **Platforms:**
          - darwin-arm64 (Apple Silicon)
          - darwin-amd64 (Intel Mac)

          **Core packages:**
          - php${VERSION}-common
          - php${VERSION}-cli
          - php${VERSION}-fpm
          - php${VERSION}-cgi
          - php${VERSION}-dev

          ### Installation

          ```bash
          phm install php${MINOR}-cli php${MINOR}-fpm
          ```

          ### Package naming

          Packages use the format: `php{VERSION}-{type}_{platform}.tar.zst`

          Example: `php${VERSION}-cli_darwin-arm64.tar.zst`
          EOF

          # Substitute variables
          sed -i "s/\${VERSION}/${VERSION}/g" release_notes.md
          sed -i "s/\${MINOR}/${MINOR}/g" release_notes.md

          # Delete existing release if present
          gh release delete "$TAG" --yes 2>/dev/null || true

          # Create release
          gh release create "$TAG" \
            --title "PHP ${VERSION}" \
            --notes-file release_notes.md \
            artifacts/*.tar.zst

  trigger-extensions:
    name: Trigger extension builds
    needs: [prepare, publish]
    if: needs.prepare.outputs.has_builds == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger extension workflows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSIONS: ${{ needs.prepare.outputs.new_versions }}
        run: |
          echo "Triggering extension builds for new PHP versions: $NEW_VERSIONS"

          # Send repository_dispatch event to trigger all extension workflows
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type="php-updated" \
            -f "client_payload[php_versions]=$NEW_VERSIONS"

          echo "Extension builds triggered"
