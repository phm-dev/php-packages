name: Build OPcache

on:
  schedule:
    - cron: '0 4 * * *'
  repository_dispatch:
    types: [php-updated]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build'
        type: boolean
        default: false

env:
  EXTENSION: opcache
  HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
  prepare:
    name: Prepare build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_builds: ${{ steps.set-matrix.outputs.has_builds }}
    steps:
      - uses: actions/checkout@v4

      - name: Get PHP versions (< 8.5 only)
        id: set-matrix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/get-php-versions.sh
          ALL_VERSIONS=$(./scripts/get-php-versions.sh --json)
          
          # Filter PHP < 8.5 (opcache is built-in for 8.5+)
          FILTERED=$(echo "$ALL_VERSIONS" | jq -c '[.[] | select(. | split(".") | .[0] + "." + .[1] | tonumber < 8.5)]')
          
          echo "PHP versions for opcache: $FILTERED"
          
          COUNT=$(echo "$FILTERED" | jq 'length')
          if [[ "$COUNT" -gt 0 ]]; then
            echo "has_builds=true" >> $GITHUB_OUTPUT
            echo "matrix={\"php_version\":$FILTERED,\"platform\":[{\"os\":\"macos-15\",\"name\":\"darwin-arm64\"},{\"os\":\"macos-13\",\"name\":\"darwin-amd64\"}]}" >> $GITHUB_OUTPUT
          else
            echo "has_builds=false" >> $GITHUB_OUTPUT
            echo "No PHP versions < 8.5 found"
          fi

  build:
    name: Build opcache for PHP ${{ matrix.php_version }}
    needs: prepare
    if: needs.prepare.outputs.has_builds == 'true'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install -q zstd

      - name: Download PHP
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PHP_VERSION="${{ matrix.php_version }}"
          PHP_MINOR="${PHP_VERSION%.*}"
          TAG="php-${PHP_VERSION}"
          
          mkdir -p /tmp/php-packages
          gh release download "$TAG" --pattern "*.tar.zst" --dir /tmp/php-packages
          
          sudo mkdir -p /opt/php/${PHP_MINOR}
          for pkg in /tmp/php-packages/*.tar.zst; do
            tar -I zstd -xf "$pkg" -C /tmp
            sudo cp -R /tmp/files/opt/php/${PHP_MINOR}/* /opt/php/${PHP_MINOR}/ 2>/dev/null || true
            rm -rf /tmp/files /tmp/pkginfo.json
          done

      - name: Build opcache from PHP source
        run: |
          # OPcache is built from PHP source ext/opcache
          echo "Building opcache for PHP ${{ matrix.php_version }}"
          # TODO: Implement opcache build from PHP source
          echo "OPcache build not yet implemented"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opcache-${{ matrix.php_version }}-${{ matrix.platform.name }}
          path: dist/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
